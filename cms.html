<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMS管理画面 - UP Global Press</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .cms-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .cms-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--accent-color);
    }
    .toggle-btn {
      display: inline-block;
      margin-bottom: 10px;
      padding: 6px 12px;
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-btn:hover {
      background: var(--highlight-color);
    }
    .releases-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    .releases-table th, .releases-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      font-size: 0.9rem;
      text-align: left;
    }
    .releases-table th {
      background: var(--secondary-bg);
    }
    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      background: var(--accent-color);
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }
    .btn:hover {
      background: var(--highlight-color);
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .json-output {
      width: 100%;
      height: 200px;
      font-size: 0.8rem;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .logout-btn {
      padding: 6px 12px;
      background: transparent;
      color: var(--accent-color);
      text-decoration: none;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      font-size: 0.9rem;
      transition: background 0.3s, color 0.3s;
      margin-left: 10px;
    }
    .logout-btn:hover {
      background: var(--accent-color);
      color: #fff;
    }
    .error-message {
      color: #d9534f;
      margin-top: 5px;
      font-size: 0.9rem;
    }
    /* コンテンツセクション用 */
    .content-section {
      border: 1px dashed var(--border-color);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .content-section label {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .add-section-btn {
      display: inline-block;
      padding: 6px 12px;
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }
    .add-section-btn:hover {
      background: var(--highlight-color);
    }
    /* タグ入力部分 */
    .tag-group {
      margin-bottom: 10px;
    }
    .tag-group label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }
    .thumbnail-note {
      font-size: 0.8rem;
      color: var(--sub-text);
      margin-top: 4px;
    }
    /* CMS内検索機能 */
    .cms-search {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .cms-search input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .cms-search button {
      padding: 6px 12px;
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .cms-search button:hover {
      background: var(--highlight-color);
    }
  </style>
  <!-- GTranslate -->
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'ja',
        includedLanguages: 'ja,en,bn',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" type="text/javascript"></script>
  <!-- TinyMCE の読み込み（CDN経由） -->
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script>
    tinymce.init({
      selector: '#cmsEditor',
      plugins: 'link lists table image code',
      toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | link image | code',
      menubar: false,
      height: 500,
      content_style: "body { font-family: 'Poppins', sans-serif; font-size:14px }",
      // カスタムスタイル：H2とBタグ
      style_formats: [
          { title: '見出し2', block: 'h2' },
          { title: '太字', inline: 'b' }
      ]
    });
  </script>
</head>
<body>
  <!-- ヘッダー読み込み（CMSは独立したヘッダー） -->
  <header>
    <div class="header-container">
      <div class="header-top">
        <div class="logo">
          <a href="index.html">UP Global Press</a>
        </div>
        <div class="header-top-right">
          <div class="language-switcher">
            <div id="google_translate_element"></div>
          </div>
          <a href="cms.html" class="cms-button">CMS</a>
          <a href="cms_login.html" class="logout-btn" onclick="localStorage.removeItem('cmsRole');">ログアウト</a>
        </div>
      </div>
      <div class="header-inner">
        <nav class="main-nav">
          <a href="index.html">ホーム</a>
          <a href="categories.html">カテゴリー</a>
          <a href="release_list.html">プレスリリース一覧</a>
          <a href="contact.html">お問い合わせ</a>
        </nav>
        <div class="search-bar">
          <input type="text" placeholder="キーワードで検索" id="searchInput">
          <button id="searchBtn">検索</button>
        </div>
        <input type="checkbox" id="menu-toggle" style="display:none;">
        <label for="menu-toggle" class="hamburger">&#9776;</label>
        <div class="mobile-nav">
          <a href="index.html">ホーム</a>
          <a href="categories.html">カテゴリー</a>
          <a href="release_list.html">プレスリリース一覧</a>
          <a href="contact.html">お問い合わせ</a>
        </div>
      </div>
    </div>
  </header>

  <main class="cms-container">
    <h1>プレスリリース管理</h1>
    <!-- CMS内検索（管理者のみ表示） -->
    <div class="cms-search" id="cmsSearchContainer">
      <input type="text" id="cmsSearchInput" placeholder="管理内検索">
      <button id="cmsSearchBtn">検索</button>
    </div>
    <div id="adminSection" style="display:none;">
      <button class="toggle-btn" id="toggleTableBtn">最小化</button>
      <table class="releases-table" id="releasesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>タイトル</th>
            <th>日付</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで挿入 -->
        </tbody>
      </table>
    </div>

    <!-- 編集／新規追加フォーム -->
    <div id="formContainer">
      <h2 id="formTitle">新規プレスリリースを追加</h2>
      <div class="form-group">
        <label for="releaseId">ID</label>
        <input type="text" id="releaseId" placeholder="自動割り当て（新規の場合）" readonly>
      </div>
      <div class="form-group">
        <label for="releaseTitle">タイトル</label>
        <input type="text" id="releaseTitle" placeholder="例：FutureTech株式会社 新型スマートフォン..." />
      </div>
      <div class="form-group">
        <label for="releaseDate">日付</label>
        <input type="date" id="releaseDate" />
      </div>
      <div class="form-group">
        <label for="releaseExcerpt">概要（excerpt）</label>
        <textarea id="releaseExcerpt" rows="2" placeholder="簡単な概要"></textarea>
      </div>
      <div class="form-group">
        <label for="releaseImg">画像URL（サムネイル用）</label>
        <input type="text" id="releaseImg" placeholder="https://..." />
        <small class="thumbnail-note">※この画像はサムネイルとして、タイトルの上に配置されます。</small>
      </div>
      <!-- コンテンツセクション追加部分 -->
      <div class="form-group">
        <label>コンテンツセクション（本文と画像、最大3セット）</label>
        <div id="contentSectionsContainer">
          <!-- 初期は1セット。セクション内は元の文章をそのまま残し、必要な箇所にのみ見出し（<h2>）やリンク（<a>）タグを追加できるように -->
          <div class="content-section">
            <label>本文 1</label>
            <!-- ※ここではシンプルなテキストエリアですが、必要に応じてTinyMCEなどのエディタを導入してもよい -->
            <textarea class="section-body" placeholder="本文を入力"></textarea>
            <label>画像 URL 1</label>
            <input type="text" class="section-img" placeholder="画像URLを入力">
          </div>
        </div>
        <button type="button" class="add-section-btn" id="addSectionBtn">＋ セクション追加</button>
      </div>
      <!-- タグ入力部分 -->
      <div class="form-group tag-group">
        <label for="releaseTagSelect">
          タグ（必須：下記9カテゴリーのいずれか1つを選択してください）
        </label>
        <select id="releaseTagSelect" required>
          <option value="">選択してください</option>
          <option value="テクノロジー">テクノロジー</option>
          <option value="ビジネス">ビジネス</option>
          <option value="エンターテインメント">エンターテインメント</option>
          <option value="ヘルスケア">ヘルスケア</option>
          <option value="環境">環境</option>
          <option value="スタートアップ">スタートアップ</option>
          <option value="ビューティー">ビューティー</option>
          <option value="グルメ">グルメ</option>
          <option value="その他">その他</option>
        </select>
        <label for="releaseAdditionalTags">追加のタグ（任意、カンマ区切り）</label>
        <input type="text" id="releaseAdditionalTags" placeholder="例：AI,IoT">
        <div id="tagError" class="error-message" style="display:none;">必ず上記のいずれか1つを選択してください。</div>
      </div>
      <button class="btn" id="saveBtn">保存</button>
      <button class="btn" id="cancelBtn" style="display:none;">キャンセル</button>
    </div>

    <!-- CMS用記事本文リッチエディタ（追加装飾機能付き） -->
    <div class="form-group">
      <label for="cmsEditor">記事本文（リッチエディタ）</label>
      <textarea id="cmsEditor">
<h2>サンプル見出し</h2>
<p>ここに<b>太字</b>や<a href="https://www.google.com" target="_blank">ハイパーリンク</a>を含む本文を入力してください。<br>
他にも、<i>イタリック</i>や<u>下線</u>、リストや引用も簡単に追加できます。</p>
      </textarea>
    </div>

    <!-- JSON生成 -->
    <div style="margin-top:30px;">
      <button class="btn" id="generateJsonBtn">Generate JSON</button>
      <textarea class="json-output" id="jsonOutput" readonly></textarea>
    </div>
  </main>

  <!-- フッター読み込み -->
  <div id="footer-placeholder"></div>

  <script src="releases.js"></script>
  <script>
    // 外部HTML読み込み関数
    async function loadHTML(url, elementId) {
      const response = await fetch(url);
      const data = await response.text();
      document.getElementById(elementId).innerHTML = data;
    }
    // CMSはヘッダーはインラインなのでフッターのみ読み込み
    loadHTML('includes/footer.html', 'footer-placeholder');

    // 検索機能設定
    function setupSearch(inputId, btnId) {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      if (input && btn) {
        btn.addEventListener("click", () => {
          const query = input.value.trim();
          if (query) {
            window.location.href = "search.html?query=" + encodeURIComponent(query);
          }
        });
        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const query = input.value.trim();
            if (query) {
              window.location.href = "search.html?query=" + encodeURIComponent(query);
            }
          }
        });
      }
    }
    document.addEventListener("DOMContentLoaded", function() {
      setupSearch("searchInput", "searchBtn");
      setupSearch("searchInputMobile", "searchBtnMobile");
    });

    // CMS管理画面用：roleに応じたJSON出力
    const role = localStorage.getItem("cmsRole");
    if (!role) {
      window.location.href = "cms_login.html";
    }
    if (role === "admin") {
      document.getElementById("adminSection").style.display = "block";
    }
    // CMS内検索機能（管理者のみ）
    if (role === "admin") {
      document.getElementById("cmsSearchBtn").addEventListener("click", function() {
        const query = document.getElementById("cmsSearchInput").value.trim().toLowerCase();
        const rows = document.querySelectorAll("#releasesTable tbody tr");
        rows.forEach(row => {
          const title = row.children[1].textContent.toLowerCase();
          row.style.display = title.includes(query) ? "" : "none";
        });
      });
    } else {
      document.getElementById("cmsSearchContainer").style.display = "none";
    }

    // 初期のデータ件数（新規作成分と判別するため）
    const initialCount = releasesData.length;
    let cmsReleasesData = JSON.parse(JSON.stringify(releasesData || []));
    const releasesTableBody = document.querySelector("#releasesTable tbody");
    const formTitle = document.getElementById("formTitle");
    const releaseIdInput = document.getElementById("releaseId");
    const releaseTitleInput = document.getElementById("releaseTitle");
    const releaseDateInput = document.getElementById("releaseDate");
    const releaseExcerptInput = document.getElementById("releaseExcerpt");
    const releaseImgInput = document.getElementById("releaseImg");
    const releaseTagSelect = document.getElementById("releaseTagSelect");
    const releaseAdditionalTags = document.getElementById("releaseAdditionalTags");
    const tagError = document.getElementById("tagError");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const generateJsonBtn = document.getElementById("generateJsonBtn");
    const jsonOutput = document.getElementById("jsonOutput");
    const REQUIRED_TAGS = ["テクノロジー", "ビジネス", "エンターテインメント", "ヘルスケア", "環境", "スタートアップ", "ビューティー", "グルメ", "その他"];
    let editIndex = null;

    // コンテンツセクションの追加処理
    const contentSectionsContainer = document.getElementById("contentSectionsContainer");
    const addSectionBtn = document.getElementById("addSectionBtn");
    addSectionBtn.addEventListener("click", () => {
      const currentSections = contentSectionsContainer.querySelectorAll(".content-section");
      if (currentSections.length >= 3) {
        alert("最大3セットまで入力できます。");
        return;
      }
      const sectionNumber = currentSections.length + 1;
      const sectionDiv = document.createElement("div");
      sectionDiv.className = "content-section";
      sectionDiv.innerHTML = `
        <label>本文 ${sectionNumber}</label>
        <textarea class="section-body" placeholder="本文を入力"></textarea>
        <label>画像 URL ${sectionNumber}</label>
        <input type="text" class="section-img" placeholder="画像URLを入力">
      `;
      contentSectionsContainer.appendChild(sectionDiv);
    });

    function getSectionsData() {
      const sections = [];
      const sectionDivs = contentSectionsContainer.querySelectorAll(".content-section");
      sectionDivs.forEach(div => {
        const body = div.querySelector(".section-body").value.trim();
        const img = div.querySelector(".section-img").value.trim();
        sections.push({ body, img });
      });
      return sections;
    }

    function renderTable() {
      if (role !== "admin") return;
      releasesTableBody.innerHTML = "";
      cmsReleasesData.forEach((rel, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rel.id}</td>
          <td>${rel.title}</td>
          <td>${rel.date}</td>
          <td>
            <button class="btn" onclick="editRelease(${index})">編集</button>
          </td>
        `;
        releasesTableBody.appendChild(tr);
      });
    }

    saveBtn.addEventListener("click", () => {
      const selectedTag = releaseTagSelect.value.trim();
      if (selectedTag === "") {
        tagError.style.display = "block";
        return;
      } else {
        tagError.style.display = "none";
      }
      let additional = releaseAdditionalTags.value.trim();
      let tagsArray = [selectedTag];
      if (additional !== "") {
        let additionalTags = additional.split(",").map(s => s.trim()).filter(Boolean);
        tagsArray = tagsArray.concat(additionalTags);
      }
      const newRelease = {
        id: releaseIdInput.value.trim(),
        title: releaseTitleInput.value.trim(),
        date: releaseDateInput.value.trim(),
        excerpt: releaseExcerptInput.value.trim(),
        img: releaseImgInput.value.trim(),
        link: "",
        sections: getSectionsData(),
        tags: tagsArray
      };
      newRelease.link = `detail.html?id=${newRelease.id}`;
      if (!newRelease.id || !newRelease.title) {
        alert("IDとタイトルは必須です。");
        return;
      }
      if (editIndex === null) {
        cmsReleasesData.push(newRelease);
      } else {
        cmsReleasesData[editIndex] = newRelease;
      }
      clearForm();
      renderTable();
    });

    cancelBtn.addEventListener("click", () => {
      clearForm();
    });

    generateJsonBtn.addEventListener("click", () => {
      let outputData = role === "editor" ? cmsReleasesData.slice(initialCount) : cmsReleasesData;
      const jsonStr = JSON.stringify(outputData, null, 2);
      jsonOutput.value = `var releasesData = ${jsonStr};`;
    });

    window.editRelease = function(index) {
      editIndex = index;
      const rel = cmsReleasesData[index];
      releaseIdInput.value = rel.id;
      releaseTitleInput.value = rel.title;
      releaseDateInput.value = rel.date;
      releaseExcerptInput.value = rel.excerpt;
      releaseImgInput.value = rel.img;
      contentSectionsContainer.innerHTML = "";
      if (rel.sections && Array.isArray(rel.sections) && rel.sections.length > 0) {
        rel.sections.forEach((sec, i) => {
          const sectionDiv = document.createElement("div");
          sectionDiv.className = "content-section";
          sectionDiv.innerHTML = `
            <label>本文 ${i+1}</label>
            <textarea class="section-body" placeholder="本文を入力">${sec.body}</textarea>
            <label>画像 URL ${i+1}</label>
            <input type="text" class="section-img" placeholder="画像URLを入力" value="${sec.img}">
          `;
          contentSectionsContainer.appendChild(sectionDiv);
        });
      } else {
        const sectionDiv = document.createElement("div");
        sectionDiv.className = "content-section";
        sectionDiv.innerHTML = `
          <label>本文 1</label>
          <textarea class="section-body" placeholder="本文を入力"></textarea>
          <label>画像 URL 1</label>
          <input type="text" class="section-img" placeholder="画像URLを入力">
        `;
        contentSectionsContainer.appendChild(sectionDiv);
      }
      if (rel.tags && Array.isArray(rel.tags) && rel.tags.length > 0) {
        releaseTagSelect.value = rel.tags[0] || "";
        releaseAdditionalTags.value = rel.tags.slice(1).join(", ");
      } else {
        releaseTagSelect.value = "";
        releaseAdditionalTags.value = "";
      }
      formTitle.textContent = "プレスリリースを編集";
      saveBtn.textContent = "更新";
      cancelBtn.style.display = "inline-block";
      document.getElementById("formContainer").scrollIntoView({ behavior: "smooth" });
    };

    function getNextId() {
      let maxId = 0;
      cmsReleasesData.forEach(item => {
        const numId = parseInt(item.id, 10);
        if (!isNaN(numId) && numId > maxId) {
          maxId = numId;
        }
      });
      return maxId + 1;
    }

    function clearForm() {
      editIndex = null;
      releaseIdInput.value = getNextId();
      releaseTitleInput.value = "";
      releaseDateInput.value = "";
      releaseExcerptInput.value = "";
      releaseImgInput.value = "";
      contentSectionsContainer.innerHTML = `
        <div class="content-section">
          <label>本文 1</label>
          <textarea class="section-body" placeholder="本文を入力"></textarea>
          <label>画像 URL 1</label>
          <input type="text" class="section-img" placeholder="画像URLを入力">
        </div>
      `;
      releaseTagSelect.value = "";
      releaseAdditionalTags.value = "";
      formTitle.textContent = "新規プレスリリースを追加";
      saveBtn.textContent = "保存";
      cancelBtn.style.display = "none";
      tagError.style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", function() {
      renderTable();
      clearForm();
    });
  </script>
</body>
</html>
