<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMS管理画面 - UP Global Press</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .cms-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .cms-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--accent-color);
    }
    .toggle-btn {
      display: inline-block;
      margin-bottom: 10px;
      padding: 6px 12px;
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-btn:hover {
      background: var(--highlight-color);
    }
    .releases-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    .releases-table th, .releases-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      font-size: 0.9rem;
      text-align: left;
    }
    .releases-table th {
      background: var(--secondary-bg);
    }
    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      background: var(--accent-color);
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }
    .btn:hover {
      background: var(--highlight-color);
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .json-output {
      width: 100%;
      height: 200px;
      font-size: 0.8rem;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .logout-btn {
      padding: 6px 12px;
      background: transparent;
      color: var(--accent-color);
      text-decoration: none;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      font-size: 0.9rem;
      transition: background 0.3s, color 0.3s;
      margin-left: 10px;
    }
    .logout-btn:hover {
      background: var(--accent-color);
      color: #fff;
    }
    .error-message {
      color: #d9534f;
      margin-top: 5px;
      font-size: 0.9rem;
    }
  </style>

  <!-- GTranslate -->
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'ja',
        includedLanguages: 'ja,en,bn',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" type="text/javascript"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <!-- 上段：ロゴ(左) + 右側（翻訳ウィジェット、CMSボタン、ログアウトボタン） -->
      <div class="header-top">
        <div class="logo">
          <a href="index.html">UP Global Press</a>
        </div>
        <div class="header-top-right">
          <div class="language-switcher">
            <div id="google_translate_element"></div>
          </div>
          <a href="cms.html" class="cms-button">CMS</a>
          <a href="cms_login.html" class="logout-btn" onclick="localStorage.removeItem('cmsRole');">ログアウト</a>
        </div>
      </div>
      <!-- 下段：ナビゲーション＆検索バー（企業概要リンク除外） -->
      <div class="header-inner">
        <nav class="main-nav">
          <a href="index.html">ホーム</a>
          <a href="categories.html">カテゴリー</a>
          <a href="release_list.html">プレスリリース一覧</a>
          <a href="contact.html">お問い合わせ</a>
        </nav>
        <div class="search-bar">
          <input type="text" placeholder="キーワードで検索" id="searchInput">
          <button id="searchBtn">検索</button>
        </div>
        <input type="checkbox" id="menu-toggle" style="display:none;">
        <label for="menu-toggle" class="hamburger">&#9776;</label>
        <div class="mobile-nav">
          <a href="index.html">ホーム</a>
          <a href="categories.html">カテゴリー</a>
          <a href="release_list.html">プレスリリース一覧</a>
          <a href="contact.html">お問い合わせ</a>
        </div>
      </div>
    </div>
  </header>

  <main class="cms-container">
    <h1>プレスリリース管理</h1>
    <!-- 管理者向け：記事一覧（最小化／展開トグル付き） -->
    <div id="adminSection" style="display:none;">
      <button class="toggle-btn" id="toggleTableBtn">最小化</button>
      <table class="releases-table" id="releasesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>タイトル</th>
            <th>日付</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで挿入 -->
        </tbody>
      </table>
    </div>

    <!-- 編集／新規追加フォーム -->
    <div id="formContainer">
      <h2 id="formTitle">新規プレスリリースを追加</h2>
      <div class="form-group">
        <label for="releaseId">ID</label>
        <input type="text" id="releaseId" placeholder="自動割り当て（新規の場合）" readonly>
      </div>
      <div class="form-group">
        <label for="releaseTitle">タイトル</label>
        <input type="text" id="releaseTitle" placeholder="例：FutureTech株式会社 新型スマートフォン..." />
      </div>
      <div class="form-group">
        <label for="releaseDate">日付</label>
        <input type="date" id="releaseDate" />
      </div>
      <div class="form-group">
        <label for="releaseExcerpt">概要（excerpt）</label>
        <textarea id="releaseExcerpt" rows="2" placeholder="簡単な概要"></textarea>
      </div>
      <div class="form-group">
        <label for="releaseImg">画像URL</label>
        <input type="text" id="releaseImg" placeholder="https://..." />
      </div>
      <div class="form-group">
        <label for="releaseContent">本文（content）</label>
        <textarea id="releaseContent" rows="5" placeholder="<p>本文HTML</p>"></textarea>
      </div>
      <div class="form-group">
        <label for="releaseTags">
          タグ（カンマ区切り）【必ず「テクノロジー」「ビジネス」「エンターテインメント」「ヘルスケア」「環境」「スタートアップ」「ビューティー」「グルメ」「その他」のいずれか1つを含む必要があります】
        </label>
        <input type="text" id="releaseTags" placeholder="例：テクノロジー,AI,ITソリューション" />
        <div id="tagError" class="error-message" style="display:none;">必ず9カテゴリーの内1つ以上のタグを含めてください。</div>
      </div>
      <button class="btn" id="saveBtn">保存</button>
      <button class="btn" id="cancelBtn" style="display:none;">キャンセル</button>
    </div>

    <!-- JSON生成 -->
    <div style="margin-top:30px;">
      <button class="btn" id="generateJsonBtn">Generate JSON</button>
      <textarea class="json-output" id="jsonOutput" readonly></textarea>
    </div>
  </main>

  <script src="releases.js"></script>
  <script>
    const role = localStorage.getItem("cmsRole");
    if(!role) {
      window.location.href = "cms_login.html";
    }
    if(role === "admin") {
      document.getElementById("adminSection").style.display = "block";
    }
    let cmsReleasesData = JSON.parse(JSON.stringify(releasesData || []));
    const releasesTableBody = document.querySelector("#releasesTable tbody");
    const formTitle = document.getElementById("formTitle");
    const releaseIdInput = document.getElementById("releaseId");
    const releaseTitleInput = document.getElementById("releaseTitle");
    const releaseDateInput = document.getElementById("releaseDate");
    const releaseExcerptInput = document.getElementById("releaseExcerpt");
    const releaseImgInput = document.getElementById("releaseImg");
    const releaseContentInput = document.getElementById("releaseContent");
    const releaseTagsInput = document.getElementById("releaseTags");
    const tagError = document.getElementById("tagError");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const generateJsonBtn = document.getElementById("generateJsonBtn");
    const jsonOutput = document.getElementById("jsonOutput");

    const REQUIRED_TAGS = [
      "テクノロジー","ビジネス","エンターテインメント","ヘルスケア","環境",
      "スタートアップ","ビューティー","グルメ","その他"
    ];

    let editIndex = null;

    renderTable();
    clearForm();

    // テーブル最小化／展開トグル
    document.getElementById("toggleTableBtn").addEventListener("click", function() {
      const table = document.getElementById("releasesTable");
      if(table.style.display === "none") {
        table.style.display = "table";
        this.textContent = "最小化";
      } else {
        table.style.display = "none";
        this.textContent = "展開";
      }
    });

    function renderTable() {
      if(role !== "admin") return;
      releasesTableBody.innerHTML = "";
      cmsReleasesData.forEach((rel, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rel.id}</td>
          <td>${rel.title}</td>
          <td>${rel.date}</td>
          <td>
            <button class="btn" onclick="editRelease(${index})">編集</button>
          </td>
        `;
        releasesTableBody.appendChild(tr);
      });
    }

    saveBtn.addEventListener("click", () => {
      const newRelease = {
        id: releaseIdInput.value.trim(),
        title: releaseTitleInput.value.trim(),
        date: releaseDateInput.value.trim(),
        excerpt: releaseExcerptInput.value.trim(),
        img: releaseImgInput.value.trim(),
        link: "", 
        content: releaseContentInput.value,
        tags: parseTags(releaseTagsInput.value)
      };
      newRelease.link = `detail.html?id=${newRelease.id}`;

      // タグ必須チェック
      const hasRequired = newRelease.tags.some(tag => REQUIRED_TAGS.includes(tag));
      if(!hasRequired) {
        tagError.style.display = "block";
        return;
      } else {
        tagError.style.display = "none";
      }

      if (!newRelease.id || !newRelease.title) {
        alert("IDとタイトルは必須です。");
        return;
      }
      if (editIndex === null) {
        cmsReleasesData.push(newRelease);
      } else {
        cmsReleasesData[editIndex] = newRelease;
      }
      clearForm();
      renderTable();
    });

    cancelBtn.addEventListener("click", () => {
      clearForm();
    });

    generateJsonBtn.addEventListener("click", () => {
      const currentTags = parseTags(releaseTagsInput.value);
      const hasReq = currentTags.some(tag => REQUIRED_TAGS.includes(tag));
      if(!hasReq) {
        alert("必ず9カテゴリーの内1つ以上のタグを含めてください。");
        return;
      }
      const jsonStr = JSON.stringify(cmsReleasesData, null, 2);
      jsonOutput.value = `var releasesData = ${jsonStr};`;
    });

    window.editRelease = function(index) {
      editIndex = index;
      const rel = cmsReleasesData[index];
      releaseIdInput.value = rel.id;
      releaseTitleInput.value = rel.title;
      releaseDateInput.value = rel.date;
      releaseExcerptInput.value = rel.excerpt;
      releaseImgInput.value = rel.img;
      releaseContentInput.value = rel.content;
      releaseTagsInput.value = rel.tags ? rel.tags.join(",") : "";
      formTitle.textContent = "プレスリリースを編集";
      saveBtn.textContent = "更新";
      cancelBtn.style.display = "inline-block";
      document.getElementById("formContainer").scrollIntoView({behavior: "smooth"});
    };

    function getNextId() {
      let maxId = 0;
      cmsReleasesData.forEach(item => {
        const numId = parseInt(item.id, 10);
        if(!isNaN(numId) && numId > maxId) {
          maxId = numId;
        }
      });
      return maxId + 1;
    }

    function clearForm() {
      editIndex = null;
      releaseIdInput.value = getNextId();
      releaseTitleInput.value = "";
      releaseDateInput.value = "";
      releaseExcerptInput.value = "";
      releaseImgInput.value = "";
      releaseContentInput.value = "";
      releaseTagsInput.value = "";
      formTitle.textContent = "新規プレスリリースを追加";
      saveBtn.textContent = "保存";
      cancelBtn.style.display = "none";
      tagError.style.display = "none";
    }

    function parseTags(tagStr) {
      if(!tagStr.trim()) return [];
      return tagStr.split(",").map(s => s.trim()).filter(Boolean);
    }

    document.addEventListener("DOMContentLoaded", function() {
      function setupSearch(searchInputId, searchBtnId) {
        const input = document.getElementById(searchInputId);
        const btn = document.getElementById(searchBtnId);
        if (input && btn) {
          btn.addEventListener("click", function() {
            const query = input.value.trim();
            window.location.href = `search.html?query=${encodeURIComponent(query)}`;
          });
          input.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
              const query = input.value.trim();
              window.location.href = `search.html?query=${encodeURIComponent(query)}`;
            }
          });
        }
      }
      setupSearch("searchInput", "searchBtn");
      setupSearch("searchInputMobile", "searchBtnMobile");
    });
  </script>
</body>
</html>
